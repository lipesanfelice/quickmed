{% extends 'base.html' %}

{% block title %}Minhass Clínicas{% endblock %}

{% block content %}
<style>
    #clinicas-table {
        width: 100%;
        max-width: 1200px;
        margin: 0 auto;
        border-collapse: collapse;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
    }

    #clinicas-table th, #clinicas-table td {
        padding: 15px;
        border: 1px solid #ddd;
        text-align: left;
    }

    #clinicas-table th {
        background-color: #f4f4f4;
    }

    #clinicas-table td:last-child {
        display: flex;
        gap: 10px;
    }

    .btn {
        padding: 5px 10px;
        text-decoration: none;
        color: white;
        border-radius: 5px;
        text-align: center;
    }
    
    .botao-editar {
        padding: 8px 16px;
        border-radius: 20px;
        background-image: linear-gradient(#256a8a, #3393c1);
        border: solid 1px #256a8a;
        font-size: 14px;
        color: white;
        font-weight: bold;
        align-self: center;
        cursor: pointer;
        text-align: center;
        margin-top: 20px;
    }

    /* Estilo do modal */
    #editModal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        justify-content: center;
        align-items: center;
    }

    #modal-content {
        width: 100%;
        max-width: 800px;
        padding: 20px;
        background-color: #ffffff;
        border-radius: 10px;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    #modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    #modal-form-content {
        display: grid;
        grid-template-columns: repeat(3, 1fr); /* Duas colunas */
        gap: 30px;
    }

    .campo-input {
        display: flex;
        flex-direction: column;
        gap: 5px; /* Reduz o espaço entre o rótulo e o campo */
    }

    .btn-edit {
        background-color: #007bff;
    }

    .btn-delete {
        background-color: #dc3545;
    }
</style>

<h1>Minhas Clínicas</h1>

<table id="clinicas-table">
    <thead>
        <tr>
            <th>Nome</th>
            <th>Descrição</th>
            <th>Telefone</th>
            <th>Email</th>
            <th>Endereço</th>
            <th>Tipo</th>
            <th>Avaliação</th>
            <th>Ações</th>
        </tr>
    </thead>
    <tbody>
        <!-- As clínicas serão inseridas aqui via JavaScript -->
    </tbody>
</table>
<!-- Modal de Edição -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="$('#editModal').hide()">&times;</span>
        <h2>Editar Clínica</h2>
        <form id="edit-form">
            <div id="modal-form-content">
                <div class="campo-input">
                <input type="hidden" id="clinica-id">
                </div>
                <div class="campo-input">
                    <label for="nome">Nome:</label>
                    <input type="text" id="nome">
                </div>
                
                <div class="campo-input">
                    <label for="descricao">Descrição:</label>
                    <textarea id="descricao"></textarea>
                </div>

                <div class="campo-input">
                    <label for="telefone">Telefone:</label>
                    <input type="text" id="telefone">
                </div>
                
                <div class="campo-input">
                    <label for="emailClinica">Email:</label>
                    <input type="email" id="emailClinica" />
                </div>
                
                <div class="campo-input">
                    <label for="endereco">Endereço:</label>
                    <input type="text" id="endereco" />
                </div>

                <div class="campo-input">
                    <label for="horario">Horário de Funcionamento:</label>
                    <input type="text" id="horario" />
                </div>
                
                <div class="campo-input">
                    <label for="latitude">Latitude:</label>
                    <input type="number" id="latitude"  min="-90" max="90" step="0.0000001" />
                </div>

                <div class="campo-input">
                    <label for="longitude">Longitude:</label>
                    <input type="number" id="longitude" min="-180" max="180" step="0.0000001" />
                </div>
                    
                <div class="campo-input">
                    <label for="tipo">Tipo:</label>
                    <select id="tipo">
                        <option value="veterinário">Veterinário</option>
                        <option value="médico">Médico</option>
                    </select>
                </div>
            </div>
            <!-- Adicione mais campos conforme necessário -->
            <div style="text-align: center;">
                <button type="submit">Salvar</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal de Confirmação de Exclusão -->
<div id="deleteModal" class="modal" style="display:none;">
    <div class="modal-content">
        <span class="close" onclick="$('#deleteModal').hide()">&times;</span>
        <h2>Confirmar Exclusão</h2>
        <p>Tem certeza de que deseja excluir esta clínica?</p>
        <button id="confirm-delete">Deletar</button>
        <button onclick="$('#deleteModal').hide()">Cancelar</button>
    </div>
</div>


{% endblock %}

{% block scripts %}
<script>
let clinicaId = null; // Variável global para armazenar o ID da clínica

    function abrirModalDeletar(clinica){

    }

    //Modal de edição da clinica
    $('#editModal').submit(function(event) {
        event.preventDefault(); // Evita a atualização da página
    
        // Coleta os dados do formulário
        const data = {
            nome: $('#nome').val(),
            descricao: $('#descricao').val(),
            telefone: $('#telefone').val(),
            email: $('#emailClinica').val(),
            endereco: $('#endereco').val(),
            latitude: $('#latitude').val(),
            longitude: $('#longitude').val(),
            tipo: $('#tipo').val(),
            avaliacao: $('#avaliacao').val(),
            horario: $('#horario').val()
        };
    
        // Envia os dados usando AJAX
        $.ajax({
            url: '/edit-user_clinics',  // URL correta para envio
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function(response) {
                alert(response.message);
                $('#editModal').hide();
                carregarClinicas();
            },
            error: function(xhr) {
                alert('Erro ao editar clínica!'); // Exibe mensagem de erro
            }
        });
    });

    //Carrega junto com a página
    $(document).ready(function() {
        // Função para carregar as clínicas
        function carregarClinicas() {
            $.get('/api/clinicas')  // Chama a rota da API para buscar as clínicas
                .done(function(clinicas) {
                    var tbody = $('#clinicas-table tbody');
                    tbody.empty();  // Limpa a tabela antes de preencher

                    clinicas.forEach(function(clinica) {
                        // Cria uma nova linha para cada clínica
                        var row = '<tr>' +
                            '<td>' + clinica.nome + '</td>' +
                            '<td>' + clinica.descricao + '</td>' +
                            '<td>' + clinica.telefone + '</td>' +
                            '<td>' + clinica.email + '</td>' +
                            '<td>' + clinica.endereco + '</td>' +
                            '<td>' + clinica.tipo + '</td>' +
                            '<td>' + (clinica.avaliacao || 'N/A') + '</td>' +
                            '<td>' +
                                '<button id="btn-edit" class="btn btn-edit">Editar</button>' +
                                '<button id="btn-delete" class="btn btn-delete" onclick="abrirModalDeletar(${clinica.id})">Deletar</button>' +
                            '</td>' +
                        '</tr>';
                        tbody.append(row);  // Adiciona a nova linha na tabela
                        // Adiciona o evento de clique para o botão "Editar"
                        $('#btn-edit').last().click(function() {
                            abrirModalEditar(clinica); // Passa o objeto clinica para a função
                        });
                    });
                })
                .fail(function(jqXHR, textStatus, errorThrown) {
                    console.error('Erro ao carregar clínicas:', textStatus, errorThrown);
                    alert('Erro ao carregar clínicas: ' + errorThrown);
                });
        }

        // Carrega as clínicas assim que a página for carregada
        carregarClinicas();
    });

    // Abrir o modal de edição e carregar os dados da clínica selecionada
    function abrirModalEditar(clinica) {
        $('#clinica-id').val(clinica.id);
        $('#nome').val(clinica.nome);
        $('#descricao').val(clinica.descricao);
        $('#telefone').val(clinica.telefone),
        $('#emailClinica').val(clinica.email),
        $('#endereco').val(clinica.endereco),
        $('#latitude').val(clinica.latitude),
        $('#longitude').val(clinica.longitude),
        $('#tipo').val(clinica.tipo),
        $('#avaliacao').val(clinica.avaliacao),
        $('#horario').val(clinica.horario)
        //document.getElementById('editModal').style.display = 'flex'
        $('#editModal').show(); // Mostrar o modal
    }

</script>
{% endblock %}