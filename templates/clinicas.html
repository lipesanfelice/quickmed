{% extends 'base.html' %}

{% block title %}Adicionar Clínica{% endblock %}

{% block content %}
    <style>

        #adicionar-clinica-form {
            width: 120%; /* Ajusta a largura do formulário */
            max-width: 1200px; /* Limite máximo */
            padding: 30px;
            box-sizing: border-box;
            background-color: #ffffff;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        #form-content {
            display: grid;
            grid-template-columns: 1fr 1fr; /* Duas colunas */
            gap: 15px; /* Espaço entre os campos */
        }

        #map-container {
            grid-column: span 2; /* Faz o mapa ocupar as duas colunas */
        }
    
        #map {
            height: 400px;
            width: 100%;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
    </style>


    <form id="adicionar-clinica-form" method="POST">
        <div class="titulo">
            <h1>Adicionar Clínica</h1>
            <div class="barra-horizontal"></div>
        </div>

        <div id="map-container">
            <label>Selecione a localização:</label>
            <div id="map"></div>
        </div>
        <div id="form-content">

            
            <div class="campo-input">
                <label for="nomeClinica">Nome:</label>
                <input type="text" id="nomeClinica" required />
            </div>
            <div class="campo-input">
                <label for="descricao">Descrição:</label>
                <textarea id="descricao"></textarea>
            </div>
            <div class="campo-input">
                <label for="telefone">Telefone:</label>
                <input type="text" id="telefone" />
            </div>
            <div class="campo-input">
                <label for="emailClinica">Email:</label>
                <input type="email" id="emailClinica" />
            </div>
            <div class="campo-input">
                <label for="endereco">Endereço:</label>
                <input type="text" id="endereco" />
            </div>
            <div class="campo-input">
                <label for="latitude">Latitude:</label>
                <input type="number" id="latitude"  min="-90" max="90" step="0.000000000000001" />
            </div>
            <div class="campo-input">
                <label for="longitude">Longitude:</label>
                <input type="number" id="longitude" min="-180" max="9180" step="0.000000000000001" />
            </div>
            <div class="campo-input">
                <label for="tipo">Tipo:</label>
                <select id="tipo">
                    <option value="veterinário">Veterinário</option>
                    <option value="médico">Médico</option>
                </select>
            </div>
            <div class="campo-input">
                <label for="avaliacao">Avaliação:</label>
                <input type="number" id="avaliacao" min="0" max="5" step="0.1" />
            </div>
            <div class="campo-input">
                <label for="horario">Horário de Funcionamento:</label>
                <input type="text" id="horario" />
            </div>
        </div>

        <button type="submit">Adicionar Clínica</button>
    </form>


{% endblock %}

{% block scripts %}
<script>
    // Inicializando o mapa com coordenadas padrão (caso a geolocalização falhe)
    const mapa = L.map('map').setView([-27.5969, -48.5495], 13);

    // Adicionando o tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19
    }).addTo(mapa);

    // Adicionando um marcador móvel ao mapa
    const marcador = L.marker([-27.5969, -48.5495], { draggable: true }).addTo(mapa);

    // Atualiza os campos de latitude e longitude com a posição do marcador
    function atualizarLatLng() {
        const posicao = marcador.getLatLng();
        document.getElementById('latitude').value = posicao.lat.toFixed(6);
        document.getElementById('longitude').value = posicao.lng.toFixed(6);
    }

    // Atualiza os campos ao mover o marcador
    marcador.on('dragend', atualizarLatLng);

    // Função para centralizar o mapa na localização do usuário ou fallback
    function centralizarMapa(lat, lng) {
        const nivelZoom = 13;
        mapa.setView([lat, lng], nivelZoom);
        marcador.setLatLng([lat, lng]);
        atualizarLatLng();
    }

    // Utiliza a API de Geolocalização para obter a posição atual do usuário
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            (posicao) => {
                const { latitude, longitude } = posicao.coords;
                centralizarMapa(latitude, longitude);
            },
            (erro) => {
                console.warn('Erro ao obter localização do usuário:', erro.message);
                alert('Não foi possível acessar sua localização. Será usada uma posição padrão.');
                atualizarLatLng(); // Fallback para valores padrão
            }
        );
    } else {
        alert('Seu navegador não suporta geolocalização. Usando coordenadas padrão.');
        atualizarLatLng(); // Fallback para valores padrão
    }

    // Atualiza os valores dos campos de latitude e longitude inicialmente
    atualizarLatLng();

    // Submissão do formulário via AJAX
    document.getElementById('adicionar-clinica-form').addEventListener('submit', function (event) {
        event.preventDefault(); // Impede o comportamento padrão do formulário

        // Coleta os dados do formulário
        const dados = {
            nome: document.getElementById('nomeClinica').value,
            descricao: document.getElementById('descricao').value,
            telefone: document.getElementById('telefone').value,
            email: document.getElementById('emailClinica').value,
            endereco: document.getElementById('endereco').value,
            latitude: document.getElementById('latitude').value,
            longitude: document.getElementById('longitude').value,
            tipo: document.getElementById('tipo').value,
            avaliacao: document.getElementById('avaliacao').value,
            horario: document.getElementById('horario').value
        };

        // Envia os dados para o backend usando Fetch API
        fetch('/clinicas', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(dados)
        })
        .then((resposta) => resposta.json())
        .then((dadosResposta) => {
            alert(dadosResposta.message); // Exibe a mensagem de sucesso
            window.location.href = '{{ url_for("map") }}'; // Redireciona para a página do mapa
        })
        .catch((erro) => {
            console.error('Erro ao adicionar clínica:', erro);
            alert('Erro ao adicionar clínica!');
        });
    });
</script>

{% endblock %}


